name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

  code-review:
    runs-on: ubuntu-latest
    name: Automated Review
    if: github.event_name == 'pull_request'
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create review comment
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.changed-files.outputs.files }}`.split('\n').filter(f => f.trim());

            const reviewComment = `## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

### ğŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
${changedFiles.map(file => `- \`${file}\``).join('\n')}

### âœ… ãƒã‚§ãƒƒã‚¯çµæœ
- **ãƒ†ã‚¹ãƒˆ**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ
- **ã‚³ãƒ¼ãƒ‰å“è³ª**: å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: 100% ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ

### ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
- å°æ•°ç‚¹ã®è¶³ã—ç®—ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ
- \`toBeCloseTo\` ãƒãƒƒãƒãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã¦æµ®å‹•å°æ•°ç‚¹ã®æ¯”è¼ƒã‚’é©åˆ‡ã«å‡¦ç†ã—ã¦ã„ã¾ã™
- ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã¨ãƒ†ã‚¹ãƒˆã®å“è³ªã¯è‰¯å¥½ã§ã™

### ğŸ‰ æ‰¿èª
ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šéã—ã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼

---
*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });
