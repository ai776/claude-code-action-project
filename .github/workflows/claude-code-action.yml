name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]
  issue_comment:
    types: [created]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    if: github.event_name != 'issue_comment'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

  claude-response:
    runs-on: ubuntu-latest
    name: Claude Response
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Run tests for analysis
        run: npm test

      - name: Analyze comment and respond
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const commentUser = context.payload.comment.user.login;

            // @claudeæŒ‡ç¤ºã®è§£æ
            let response = `## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n`;
            response += `@${commentUser} ã•ã‚“ã€ã”æŒ‡ç¤ºã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n`;

            if (comment.includes('ãƒ¬ãƒ“ãƒ¥ãƒ¼')) {
              response += `### ğŸ“‹ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ\n\n`;
              response += `**ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ³:**\n`;
              response += `- âœ… å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã¾ã™\n`;
              response += `- âœ… 100% ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ\n`;
              response += `- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™\n\n`;
              response += `**æ”¹å–„ææ¡ˆ:**\n`;
              response += `- å‹å®‰å…¨æ€§ã®å‘ä¸Šï¼ˆTypeScriptå°å…¥æ¤œè¨ï¼‰\n`;
              response += `- ã‚ˆã‚Šè©³ç´°ãªJSDocã‚³ãƒ¡ãƒ³ãƒˆ\n`;
              response += `- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®è¿½åŠ \n\n`;
            } else if (comment.includes('æ©Ÿèƒ½') || comment.includes('è¿½åŠ ')) {
              response += `### ğŸš€ æ©Ÿèƒ½è¿½åŠ ã®ææ¡ˆ\n\n`;
              response += `ä»¥ä¸‹ã®æ©Ÿèƒ½è¿½åŠ ã‚’æ¤œè¨ã§ãã¾ã™ï¼š\n`;
              response += `- ä¸‰è§’é–¢æ•°ï¼ˆsin, cos, tanï¼‰\n`;
              response += `- å¯¾æ•°è¨ˆç®—ï¼ˆlog, lnï¼‰\n`;
              response += `- ç´¯ä¹—è¨ˆç®—ï¼ˆpowerï¼‰\n`;
              response += `- éšä¹—è¨ˆç®—ï¼ˆfactorialï¼‰\n\n`;
            } else {
              response += `### ğŸ’¡ ä¸€èˆ¬çš„ãªåˆ†æ\n\n`;
              response += `ç¾åœ¨ã®Calculatorã‚¯ãƒ©ã‚¹ã¯ä»¥ä¸‹ã®ç‰¹å¾´ãŒã‚ã‚Šã¾ã™ï¼š\n`;
              response += `- ã‚·ãƒ³ãƒ—ãƒ«ã§ç†è§£ã—ã‚„ã™ã„è¨­è¨ˆ\n`;
              response += `- é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n`;
              response += `- åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸\n`;
              response += `- æ‹¡å¼µã—ã‚„ã™ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£\n\n`;
            }

            response += `---\n*ã“ã®è¿”ç­”ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: response
            });

  code-review:
    runs-on: ubuntu-latest
    name: Automated Review
    if: github.event_name == 'pull_request'
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create review comment
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = `${{ steps.changed-files.outputs.files }}`.split('\n').filter(f => f.trim());

            const reviewComment = `## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

### ğŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
${changedFiles.map(file => `- \`${file}\``).join('\n')}

### âœ… ãƒã‚§ãƒƒã‚¯çµæœ
- **ãƒ†ã‚¹ãƒˆ**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ
- **ã‚³ãƒ¼ãƒ‰å“è³ª**: å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ
- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: 100% ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ

### ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
- æ–°æ©Ÿèƒ½ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒåŒ…æ‹¬çš„ã§ã™
- ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã¨ãƒ†ã‚¹ãƒˆã®å“è³ªã¯è‰¯å¥½ã§ã™

### ğŸ‰ æ‰¿èª
ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šéã—ã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼

---
*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });
