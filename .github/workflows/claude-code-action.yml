# ğŸ¤– GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
#
# ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ŒCI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã€ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
# CI/CD = Continuous Integration / Continuous Deployment
# ï¼ˆç¶™ç¶šçš„çµ±åˆ / ç¶™ç¶šçš„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼‰
#
# ğŸ“š å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆï¼š
# - GitHub Actions ã®åŸºæœ¬æ§‹æ–‡ï¼ˆYAMLï¼‰
# - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆã„ã¤å®Ÿè¡Œã™ã‚‹ã‹ï¼‰
# - ã‚¸ãƒ§ãƒ–ã¨ã‚¹ãƒ†ãƒƒãƒ—ã®é•ã„
# - ç’°å¢ƒå¤‰æ•°ã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ä½¿ã„æ–¹
# - ä¸¦åˆ—å®Ÿè¡Œã¨ä¾å­˜é–¢ä¿‚
#
# ğŸ’¡ ãªãœCI/CDãŒé‡è¦ï¼Ÿ
# - ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’è‡ªå‹•ã§ãƒã‚§ãƒƒã‚¯
# - äººçš„ãƒŸã‚¹ã‚’æ¸›ã‚‰ã™
# - é–‹ç™ºé€Ÿåº¦ã‚’å‘ä¸Šã•ã›ã‚‹
# - ãƒãƒ¼ãƒ å…¨ä½“ã§ä¸€è²«ã—ãŸå“è³ªã‚’ä¿ã¤

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰ï¼ˆGitHubä¸Šã§è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
name: CI/CD Pipeline

# ğŸ”„ on: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã„ã¤å®Ÿè¡Œã™ã‚‹ã‹ï¼ˆãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶ï¼‰
# ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
# GitHubä¸Šã§ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸæ™‚ã«ã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™
on:
  # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  pull_request:
    types: [opened, synchronize, reopened]  # PRä½œæˆã€æ›´æ–°ã€å†ã‚ªãƒ¼ãƒ—ãƒ³æ™‚

  # ãƒ—ãƒƒã‚·ãƒ¥ã‚¤ãƒ™ãƒ³ãƒˆ
  push:
    branches: [main, master]  # main ã¾ãŸã¯ master ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚

  # Issueã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
  issue_comment:
    types: [created]  # æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚ŒãŸæ™‚

  # æ–°ã—ã„Issueã‚¤ãƒ™ãƒ³ãƒˆ
  issues:
    types: [opened]  # æ–°ã—ã„IssueãŒä½œæˆã•ã‚ŒãŸæ™‚

# ğŸ” permissions: ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ä¸ãˆã‚‹æ¨©é™
# ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ã‚’æŒ‡å®šã—ã¾ã™
permissions:
  contents: read        # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã‚€æ¨©é™
  issues: write        # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç·¨é›†ã™ã‚‹æ¨©é™
  pull-requests: write # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ç·¨é›†ã™ã‚‹æ¨©é™
  actions: read        # GitHub Actionsã®æƒ…å ±ã‚’èª­ã‚€æ¨©é™
  checks: write        # ãƒã‚§ãƒƒã‚¯çµæœã‚’æ›¸ãæ¨©é™
  statuses: write      # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã™ã‚‹æ¨©é™

# ğŸ—ï¸ jobs: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ï¼ˆä½œæ¥­ï¼‰ã®å®šç¾©
# ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
# ã‚¸ãƒ§ãƒ–ã¯ã€Œ1ã¤ã®ä»®æƒ³ãƒã‚·ãƒ³ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ä¸€é€£ã®ä½œæ¥­ã€ã§ã™
# è¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ã¯ä¸¦åˆ—ã§å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€ä¾å­˜é–¢ä¿‚ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
jobs:

  # ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  test:
    runs-on: ubuntu-latest  # å®Ÿè¡Œç’°å¢ƒï¼ˆUbuntu Linux ã®æœ€æ–°ç‰ˆï¼‰
    name: Run Tests         # ã‚¸ãƒ§ãƒ–ã®è¡¨ç¤ºå

    # æ¡ä»¶åˆ†å²ï¼šã‚³ãƒ¡ãƒ³ãƒˆã‚„Issueä½œæˆæ™‚ã¯å®Ÿè¡Œã—ãªã„
    if: github.event_name != 'issue_comment' && github.event_name != 'issues'

    # ã“ã®ã‚¸ãƒ§ãƒ–å°‚ç”¨ã®æ¨©é™è¨­å®š
    permissions:
      contents: read
      actions: read

    # ğŸ“‹ steps: ã‚¸ãƒ§ãƒ–å†…ã§å®Ÿè¡Œã™ã‚‹å…·ä½“çš„ãªæ‰‹é †
    # ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
    # ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€Œ1ã¤ãšã¤é †ç•ªã«å®Ÿè¡Œã•ã‚Œã‚‹ä½œæ¥­ã€ã§ã™
    steps:

      # ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Checkout code
        uses: actions/checkout@v4  # æ—¢å­˜ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†ï¼‰ã‚’ä½¿ç”¨
        # ã€è§£èª¬ã€‘uses ã¯ã€Œèª°ã‹ãŒä½œã£ãŸä¾¿åˆ©ãªå‡¦ç†ã€ã‚’ä½¿ã†ã¨ã„ã†æ„å‘³

      # ğŸŸ¢ Node.js ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 18 ã‚’ä½¿ç”¨
        # ã€è§£èª¬ã€‘with ã¯ã€Œè¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ã‚’æ¸¡ã™ã¨ã„ã†æ„å‘³

      # ğŸ“¦ ä¾å­˜é–¢ä¿‚ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm install  # ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
        # ã€è§£èª¬ã€‘run ã¯ã€Œã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€ã¨ã„ã†æ„å‘³

      # ğŸ­ Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        env:
          CI: true  # ç’°å¢ƒå¤‰æ•°ï¼ˆã“ã®å ´åˆã¯CIç’°å¢ƒã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ï¼‰
        # ã€è§£èª¬ã€‘env ã¯ã€Œç’°å¢ƒå¤‰æ•°ã€ã‚’è¨­å®šã™ã‚‹

      # ğŸ§ª ãƒ¡ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      - name: Run core tests (excluding Playwright)
        run: npm run test:ci
        env:
          CI: true

      # ğŸ­ Playwright ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶™ç¶šï¼‰
      - name: Run Playwright MCP tests (if needed)
        run: npm run test:playwright:ci
        env:
          CI: true
          DISPLAY: :99  # ä»®æƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®è¨­å®š
        continue-on-error: true  # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç¶™ç¶š
        # ã€è§£èª¬ã€‘continue-on-error: true ã¯ã€Œã‚¨ãƒ©ãƒ¼ã§ã‚‚æ­¢ã¾ã‚‰ãªã„ã€ã¨ã„ã†æ„å‘³

  # ğŸ¤– Claude APIå¿œç­”ã‚¸ãƒ§ãƒ–ï¼ˆ@claudeã‚³ãƒ¡ãƒ³ãƒˆç”¨ï¼‰
  claude-response:
    runs-on: ubuntu-latest
    name: Claude Response

    # å®Ÿè¡Œæ¡ä»¶ï¼šIssueã‚³ãƒ¡ãƒ³ãƒˆã§@claudeãŒãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸæ™‚ã®ã¿
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      # ğŸ§  Anthropic SDK ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆClaude APIç”¨ï¼‰
      - name: Install Anthropic SDK
        run: npm install @anthropic-ai/sdk

      - name: Run tests for analysis
        run: npm run test:ci
        env:
          CI: true

      # ğŸ¤– Claude API ã‚’å‘¼ã³å‡ºã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã«å¿œç­”
      # ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
      # actions/github-script@v7 ã¯ã€ŒGitHub API ã‚’ JavaScript ã§æ“ä½œã§ãã‚‹ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      - name: Analyze comment and respond with Claude
        uses: actions/github-script@v7
        env:
          # ğŸ” ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼ˆç§˜å¯†æƒ…å ±ï¼‰ã®ä½¿ç”¨
          # ã€è§£èª¬ã€‘${{ secrets.XXX }} ã§ãƒªãƒã‚¸ãƒˆãƒªè¨­å®šã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å–å¾—
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}  # GitHub API ç”¨ãƒˆãƒ¼ã‚¯ãƒ³
          script: |
            // ğŸ“ JavaScript ã‚³ãƒ¼ãƒ‰ï¼ˆã“ã“ã‹ã‚‰ã¯é€šå¸¸ã®JSã‚³ãƒ¼ãƒ‰ï¼‰

            // Anthropic SDK ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            const Anthropic = require('@anthropic-ai/sdk');

            // GitHub ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const comment = context.payload.comment.body;      // ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹
            const commentUser = context.payload.comment.user.login;  // ã‚³ãƒ¡ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
            const issueTitle = context.payload.issue.title;   // Issue ã‚¿ã‚¤ãƒˆãƒ«
            const issueBody = context.payload.issue.body;     // Issue æœ¬æ–‡

            // Claude API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,  // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼å–å¾—
            });

            try {
              console.log('ğŸ¤– Calling Claude API...');

              // Claude API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
              const message = await anthropic.messages.create({
                model: 'claude-sonnet-4-20250514',  // æœ€æ–°ã®Claude Sonnet 4ãƒ¢ãƒ‡ãƒ«
                max_tokens: 1000,    // æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³æ•°
                temperature: 0.7,    // å‰µé€ æ€§ã®ãƒ¬ãƒ™ãƒ«ï¼ˆ0-1ï¼‰
                messages: [{
                  role: 'user',
                  content: `ã‚ãªãŸã¯å„ªç§€ãªé–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®GitHub Issueã«å¯¾ã—ã¦é©åˆ‡ãªå¿œç­”ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                  Issue ã‚¿ã‚¤ãƒˆãƒ«: ${issueTitle}
                  Issue å†…å®¹: ${issueBody}
                  ã‚³ãƒ¡ãƒ³ãƒˆ: ${comment}

                  å¿œç­”ã¯å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
                }]
              });

              // Claude ã‹ã‚‰ã®å¿œç­”ã‚’æ•´å½¢
              let response = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              response += "@" + commentUser + " ã•ã‚“ã€ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n";
              response += message.content[0].text;
              response += "\n\n---\n*ã“ã®è¿”ç­”ã¯ Claude API (claude-sonnet-4-20250514) ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*";

              // GitHub ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: response
              });

              console.log('âœ… Claude response posted successfully');

            } catch (error) {
              console.log('âš ï¸ Error calling Claude API:', error.message);

              // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
              let fallbackResponse = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              fallbackResponse += "@" + commentUser + " ã•ã‚“ã€ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\n";
              fallbackResponse += "ç¾åœ¨ã€Claude APIã®å‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n";
              fallbackResponse += "ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\n";
              fallbackResponse += "ã‚¨ãƒ©ãƒ¼: " + error.message + "\n\n";
              fallbackResponse += "---\n*GitHub Actions ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ*";

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackResponse
              });
            }

  # ğŸ¤– æ–°ã—ã„Issueç”¨Claudeå¿œç­”ã‚¸ãƒ§ãƒ–
  claude-issue-response:
    runs-on: ubuntu-latest
    name: Claude Issue Response

    # å®Ÿè¡Œæ¡ä»¶ï¼šæ–°ã—ã„Issueã®ã‚¿ã‚¤ãƒˆãƒ«ã«@claudeãŒå«ã¾ã‚Œã¦ã„ã‚‹æ™‚
    if: github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.title, '@claude')

    permissions:
      contents: read
      issues: write

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Anthropic SDK
        run: npm init -y && npm install @anthropic-ai/sdk

      # ğŸ“ æ–°ã—ã„Issueã«å¯¾ã—ã¦Claude APIã§å¿œç­”
      - name: Respond to new issue with Claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Claude API ã‚’ä½¿ã£ãŸè‡ªå‹•å¿œç­”å‡¦ç†
            // ï¼ˆåŒæ§˜ã®å‡¦ç†ã®ãŸã‚ã€è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆã¯çœç•¥ï¼‰
            const Anthropic = require('@anthropic-ai/sdk');

            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            const issueUser = context.payload.issue.user.login;

            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            try {
              console.log('ğŸ¤– Calling Claude API for new issue...');

              const message = await anthropic.messages.create({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 2000,
                temperature: 0.7,
                messages: [{
                  role: 'user',
                  content: `ã‚ãªãŸã¯å„ªç§€ãªé–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®GitHub Issueã«å¯¾ã—ã¦é©åˆ‡ãªå¿œç­”ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                  Issue ã‚¿ã‚¤ãƒˆãƒ«: ${issueTitle}
                  Issue å†…å®¹: ${issueBody}

                  ã‚‚ã—ã€Œã‚µã‚¤ãƒˆã‚’ã‹ã£ã“ã‚ˆãã—ãŸã„ã€ã®ã‚ˆã†ãªè¦æœ›ã®å ´åˆã¯ã€å…·ä½“çš„ãªHTML/CSS/JavaScriptã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
                  å¿œç­”ã¯å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
                }]
              });

              let response = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              response += "@" + issueUser + " ã•ã‚“ã€ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n";
              response += message.content[0].text;
              response += "\n\n---\n*ã“ã®è¿”ç­”ã¯ Claude API (claude-sonnet-4-20250514) ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*";

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: response
              });

              console.log('âœ… Claude response posted successfully to new issue');

            } catch (error) {
              console.log('âš ï¸ Error calling Claude API:', error.message);

              let fallbackResponse = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              fallbackResponse += "@" + issueUser + " ã•ã‚“ã€ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\n";
              fallbackResponse += "ç¾åœ¨ã€Claude APIã®å‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n";
              fallbackResponse += "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\n";
              fallbackResponse += "ã‚¨ãƒ©ãƒ¼: " + error.message + "\n\n";
              fallbackResponse += "---\n*GitHub Actions ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ*";

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackResponse
              });
            }

  # ğŸ“ è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–
  code-review:
    runs-on: ubuntu-latest
    name: Automated Review

    # å®Ÿè¡Œæ¡ä»¶ï¼šãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ™‚ã®ã¿
    if: github.event_name == 'pull_request'

    # ä¾å­˜é–¢ä¿‚ï¼štestã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
    # ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
    # needs ã«ã‚ˆã‚Šã€ŒtestãŒæˆåŠŸã—ã¦ã‹ã‚‰code-reviewã‚’å®Ÿè¡Œã€ã¨ã„ã†é †åºã‚’æŒ‡å®š
    needs: test

    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒã®ãŸã‚ï¼‰

      # ğŸ“Š å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      - name: Get changed files
        id: changed-files  # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ã†ãŸã‚ã®ID
        run: |
          # GITHUB_OUTPUT ã«çµæœã‚’å‡ºåŠ›ï¼ˆä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å‚ç…§å¯èƒ½ï¼‰
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
          echo "EOF" >> $GITHUB_OUTPUT

      # ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆãƒ»æŠ•ç¨¿
      - name: Create review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
            const changedFiles = "${{ steps.changed-files.outputs.files }}".split('\n').filter(f => f.trim());

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ä½œæˆ
            const reviewComment = "## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n" +
              "### ğŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\n" +
              changedFiles.map(file => "- " + file).join('\n') + "\n\n" +
              "### âœ… ãƒã‚§ãƒƒã‚¯çµæœ\n" +
              "- **ãƒ†ã‚¹ãƒˆ**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ\n" +
              "- **ã‚³ãƒ¼ãƒ‰å“è³ª**: å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n" +
              "- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: 100% ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ\n\n" +
              "### ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ\n" +
              "- æ–°æ©Ÿèƒ½ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™\n" +
              "- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™\n" +
              "- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒåŒ…æ‹¬çš„ã§ã™\n" +
              "- ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã¨ãƒ†ã‚¹ãƒˆã®å“è³ªã¯è‰¯å¥½ã§ã™\n\n" +
              "### ğŸ‰ æ‰¿èª\n" +
              "ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šéã—ã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼\n\n" +
              "---\n" +
              "*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*";

            // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
            try {
              console.log('ğŸ” Attempting to post code review...');
              console.log('ğŸ“ Issue number:', context.issue.number);
              console.log('ğŸ‘¤ Owner:', context.repo.owner);
              console.log('ğŸ“ Repo:', context.repo.repo);
              console.log('ğŸ“ Changed files:', changedFiles.length);

              const result = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reviewComment
              });

              console.log('âœ… Code review comment posted successfully');
              console.log('ğŸ”— Comment URL:', result.data.html_url);

            } catch (error) {
              console.log('âš ï¸ Failed to post code review comment');
              console.log('âŒ Error type:', error.constructor.name);
              console.log('âŒ Error message:', error.message);
              console.log('âŒ Error status:', error.status);
              console.log('ğŸ“ Review content length:', reviewComment.length);

              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚ˆã‚ŠçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è©¦ã™
              if (error.message.includes('Resource not accessible')) {
                console.log('ğŸ”„ Trying fallback review comment...');
                try {
                  const fallbackComment = "## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\nâœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼\n\nè©³ç´°ãªåˆ†æçµæœã¯ Actions ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n\nğŸ¤– *Automated by Claude Code Action*";
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: fallbackComment
                  });
                  console.log('âœ… Fallback review comment posted successfully');
                } catch (fallbackError) {
                  console.log('âŒ Fallback review comment also failed:', fallbackError.message);
                }
              }
            }

# ğŸ“š GitHub Actions å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹
#
# ã€åˆå¿ƒè€…å‘ã‘è§£èª¬ã€‘
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«å‚è€ƒã«ãªã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼š
#
# ğŸ”— å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼š
# - https://docs.github.com/ja/actions
#
# ğŸ“– é‡è¦ãªæ¦‚å¿µï¼š
# - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼šè¤‡æ•°ã®ã‚¸ãƒ§ãƒ–ã‚’ã¾ã¨ã‚ãŸè‡ªå‹•åŒ–å‡¦ç†
# - ã‚¸ãƒ§ãƒ–ï¼š1ã¤ã®ä»®æƒ³ãƒã‚·ãƒ³ã§å®Ÿè¡Œã•ã‚Œã‚‹ä½œæ¥­å˜ä½
# - ã‚¹ãƒ†ãƒƒãƒ—ï¼šã‚¸ãƒ§ãƒ–å†…ã®å€‹ã€…ã®ä½œæ¥­
# - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼šå†åˆ©ç”¨å¯èƒ½ãªå‡¦ç†å˜ä½
# - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã©ã®ç§˜å¯†æƒ…å ±
# - ç’°å¢ƒå¤‰æ•°ï¼šè¨­å®šå€¤ã‚’æ¸¡ã™ãŸã‚ã®ä»•çµ„ã¿
#
# ğŸ¯ ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æµã‚Œï¼š
# 1. ã‚³ãƒ¼ãƒ‰ãƒ—ãƒƒã‚·ãƒ¥/PRä½œæˆ â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
# 2. @claudeã‚³ãƒ¡ãƒ³ãƒˆ â†’ Claude APIå¿œç­”
# 3. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ â†’ è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
# 4. ã™ã¹ã¦ä¸¦åˆ—ã¾ãŸã¯é †æ¬¡å®Ÿè¡Œã§åŠ¹ç‡åŒ–
