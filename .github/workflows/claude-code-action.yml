name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]
  issue_comment:
    types: [created]
  issues:
    types: [opened]

# ã‚ˆã‚Šæ˜ç¤ºçš„ãªæ¨©é™è¨­å®š
permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: read
  checks: write
  statuses: write

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    if: github.event_name != 'issue_comment' && github.event_name != 'issues'
    # ã‚¸ãƒ§ãƒ–ãƒ¬ãƒ™ãƒ«ã§ã‚‚æ¨©é™ã‚’æ˜ç¤º
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        env:
          CI: true

      - name: Run core tests (excluding Playwright)
        run: npm run test:ci
        env:
          CI: true

      - name: Run Playwright MCP tests (if needed)
        run: npm run test:playwright:ci
        env:
          CI: true
          DISPLAY: :99
        continue-on-error: true  # Playwrightãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶šè¡Œ

  claude-response:
    runs-on: ubuntu-latest
    name: Claude Response
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')
    # ã‚¸ãƒ§ãƒ–ãƒ¬ãƒ™ãƒ«ã§ã‚‚æ¨©é™ã‚’æ˜ç¤º
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Install Anthropic SDK
        run: npm install @anthropic-ai/sdk

      - name: Run tests for analysis
        run: npm run test:ci
        env:
          CI: true

      - name: Analyze comment and respond with Claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Anthropic SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            const Anthropic = require('@anthropic-ai/sdk');

            const comment = context.payload.comment.body;
            const commentUser = context.payload.comment.user.login;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;

            // Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            try {
              console.log('ğŸ¤– Calling Claude API...');

              // Claudeã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
              const message = await anthropic.messages.create({
                model: 'claude-3-opus-20240229',
                max_tokens: 1000,
                temperature: 0.7,
                messages: [{
                  role: 'user',
                  content: `ã‚ãªãŸã¯å„ªç§€ãªé–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®GitHub Issueã«å¯¾ã—ã¦é©åˆ‡ãªå¿œç­”ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                  Issue ã‚¿ã‚¤ãƒˆãƒ«: ${issueTitle}
                  Issue å†…å®¹: ${issueBody}
                  ã‚³ãƒ¡ãƒ³ãƒˆ: ${comment}

                  å¿œç­”ã¯å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
                }]
              });

              // Claudeã‹ã‚‰ã®å¿œç­”ã‚’æ•´å½¢
              let response = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              response += "@" + commentUser + " ã•ã‚“ã€ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n";
              response += message.content[0].text;
              response += "\n\n---\n*ã“ã®è¿”ç­”ã¯ Claude API (claude-3-opus) ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*";

              // GitHubã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: response
              });

              console.log('âœ… Claude response posted successfully');

            } catch (error) {
              console.log('âš ï¸ Error calling Claude API:', error.message);

              // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
              let fallbackResponse = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              fallbackResponse += "@" + commentUser + " ã•ã‚“ã€ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\n";
              fallbackResponse += "ç¾åœ¨ã€Claude APIã®å‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n";
              fallbackResponse += "ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\n";
              fallbackResponse += "ã‚¨ãƒ©ãƒ¼: " + error.message + "\n\n";
              fallbackResponse += "---\n*GitHub Actions ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ*";

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackResponse
              });
            }

  claude-issue-response:
    runs-on: ubuntu-latest
    name: Claude Issue Response
    if: github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.title, '@claude')
    permissions:
      contents: read
      issues: write

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Anthropic SDK
        run: npm init -y && npm install @anthropic-ai/sdk

      - name: Respond to new issue with Claude
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const Anthropic = require('@anthropic-ai/sdk');

            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            const issueUser = context.payload.issue.user.login;

            // Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            try {
              console.log('ğŸ¤– Calling Claude API for new issue...');

              // Claudeã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
              const message = await anthropic.messages.create({
                model: 'claude-3-opus-20240229',
                max_tokens: 2000,
                temperature: 0.7,
                messages: [{
                  role: 'user',
                  content: `ã‚ãªãŸã¯å„ªç§€ãªé–‹ç™ºã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®GitHub Issueã«å¯¾ã—ã¦é©åˆ‡ãªå¿œç­”ã‚’æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                  Issue ã‚¿ã‚¤ãƒˆãƒ«: ${issueTitle}
                  Issue å†…å®¹: ${issueBody}

                  ã‚‚ã—ã€Œã‚µã‚¤ãƒˆã‚’ã‹ã£ã“ã‚ˆãã—ãŸã„ã€ã®ã‚ˆã†ãªè¦æœ›ã®å ´åˆã¯ã€å…·ä½“çš„ãªHTML/CSS/JavaScriptã®ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
                  å¿œç­”ã¯å…·ä½“çš„ã§å®Ÿè£…å¯èƒ½ãªææ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`
                }]
              });

              // Claudeã‹ã‚‰ã®å¿œç­”ã‚’æ•´å½¢
              let response = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              response += "@" + issueUser + " ã•ã‚“ã€ã”ä¾é ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\n\n";
              response += message.content[0].text;
              response += "\n\n---\n*ã“ã®è¿”ç­”ã¯ Claude API (claude-3-opus) ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*";

              // GitHubã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: response
              });

              console.log('âœ… Claude response posted successfully to new issue');

            } catch (error) {
              console.log('âš ï¸ Error calling Claude API:', error.message);

              // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
              let fallbackResponse = "## ğŸ¤– Claude ã‹ã‚‰ã®è¿”ç­”\n\n";
              fallbackResponse += "@" + issueUser + " ã•ã‚“ã€ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\n\n";
              fallbackResponse += "ç¾åœ¨ã€Claude APIã®å‘¼ã³å‡ºã—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n";
              fallbackResponse += "APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\n";
              fallbackResponse += "ã‚¨ãƒ©ãƒ¼: " + error.message + "\n\n";
              fallbackResponse += "---\n*GitHub Actions ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ*";

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: fallbackResponse
              });
            }

  code-review:
    runs-on: ubuntu-latest
    name: Automated Review
    if: github.event_name == 'pull_request'
    needs: test
    # ã‚¸ãƒ§ãƒ–ãƒ¬ãƒ™ãƒ«ã§ã‚‚æ¨©é™ã‚’æ˜ç¤º
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }}
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedFiles = "${{ steps.changed-files.outputs.files }}".split('\n').filter(f => f.trim());

            const reviewComment = "## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n" +
              "### ğŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«\n" +
              changedFiles.map(file => "- " + file).join('\n') + "\n\n" +
              "### âœ… ãƒã‚§ãƒƒã‚¯çµæœ\n" +
              "- **ãƒ†ã‚¹ãƒˆ**: ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ\n" +
              "- **ã‚³ãƒ¼ãƒ‰å“è³ª**: å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n" +
              "- **ã‚«ãƒãƒ¬ãƒƒã‚¸**: 100% ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’é”æˆ\n\n" +
              "### ğŸ“ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ\n" +
              "- æ–°æ©Ÿèƒ½ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™\n" +
              "- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™\n" +
              "- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒåŒ…æ‹¬çš„ã§ã™\n" +
              "- ã‚³ãƒ¼ãƒ‰ã®æ§‹é€ ã¨ãƒ†ã‚¹ãƒˆã®å“è³ªã¯è‰¯å¥½ã§ã™\n\n" +
              "### ğŸ‰ æ‰¿èª\n" +
              "ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šéã—ã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ï¼\n\n" +
              "---\n" +
              "*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*";

            // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            try {
              console.log('ğŸ” Attempting to post code review...');
              console.log('ğŸ“ Issue number:', context.issue.number);
              console.log('ğŸ‘¤ Owner:', context.repo.owner);
              console.log('ğŸ“ Repo:', context.repo.repo);
              console.log('ğŸ“ Changed files:', changedFiles.length);

              const result = await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: reviewComment
              });

              console.log('âœ… Code review comment posted successfully');
              console.log('ğŸ”— Comment URL:', result.data.html_url);
            } catch (error) {
              console.log('âš ï¸ Failed to post code review comment');
              console.log('âŒ Error type:', error.constructor.name);
              console.log('âŒ Error message:', error.message);
              console.log('âŒ Error status:', error.status);
              console.log('ğŸ“ Review content length:', reviewComment.length);

              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚ˆã‚ŠçŸ­ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è©¦ã™
              if (error.message.includes('Resource not accessible')) {
                console.log('ğŸ”„ Trying fallback review comment...');
                try {
                  const fallbackComment = "## ğŸ¤– è‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\nâœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼\n\nè©³ç´°ãªåˆ†æçµæœã¯ Actions ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n\nğŸ¤– *Automated by Claude Code Action*";
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: fallbackComment
                  });
                  console.log('âœ… Fallback review comment posted successfully');
                } catch (fallbackError) {
                  console.log('âŒ Fallback review comment also failed:', fallbackError.message);
                }
              }
            }
