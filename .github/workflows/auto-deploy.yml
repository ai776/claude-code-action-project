name: Auto Code Generation and Deploy

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  id-token: write

jobs:
  auto-generate-and-deploy:
    runs-on: ubuntu-latest
    name: Auto Generate Code and Deploy
    if: |
      contains(github.event.issue.title, '@claude') && (
        contains(github.event.issue.labels.*.name, 'auto-deploy') ||
        contains(github.event.issue.labels.*.name, 'line-bot') ||
        contains(github.event.issue.body, 'ãƒ•ã‚©ãƒ¼ãƒ ') ||
        contains(github.event.issue.body, 'ä½œæˆ')
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Generate code with Claude
        id: generate-code
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const Anthropic = require('@anthropic-ai/sdk');
            const fs = require('fs');

            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;

            console.log('ğŸ” å‡¦ç†é–‹å§‹:', issueTitle);

            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            try {
              console.log('ğŸ¤– Claude APIã‚’å‘¼ã³å‡ºã—ä¸­...');

              const message = await anthropic.messages.create({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4000,
                temperature: 0.3,
                messages: [{
                  role: 'user',
                  content: `ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã®HTMLãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

                  è¦ä»¶:
                  - å®Œå…¨ã«å‹•ä½œã™ã‚‹HTML/CSS/JavaScript
                  - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
                  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
                  - ãƒ¢ãƒ€ãƒ³ãªãƒ‡ã‚¶ã‚¤ãƒ³
                  - 1ã¤ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«å…¨ã¦å«ã‚ã‚‹

                  ä»¥ä¸‹ã®å½¢å¼ã§è¿”ç­”ã—ã¦ãã ã•ã„:

                  \`\`\`html
                  [å®Œå…¨ãªHTMLã‚³ãƒ¼ãƒ‰]
                  \`\`\``
                }]
              });

              const generatedContent = message.content[0].text;
              console.log('âœ… ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†');

              // HTMLã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
              const htmlMatch = generatedContent.match(/```html\n([\s\S]*?)```/);

              let htmlCode;
              if (htmlMatch) {
                htmlCode = htmlMatch[1];
                console.log('âœ… HTMLã‚³ãƒ¼ãƒ‰æŠ½å‡ºæˆåŠŸ');
              } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ HTMLï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªå½¢å¼ï¼‰
                htmlCode = `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; padding: 20px; }
.container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
.header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; text-align: center; padding: 30px; }
.form { padding: 30px; }
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
input, textarea, select { width: 100%; padding: 12px 16px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; }
input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
button { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
button:hover { transform: translateY(-2px); }
.required { color: #e74c3c; }
.success { display: none; text-align: center; padding: 30px; }
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </h1>
<p>ã”è³ªå•ã‚„ã”ç›¸è«‡ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
</div>
<div class="form">
<form id="contactForm">
<div class="form-group">
<label for="name">ãŠåå‰ <span class="required">*</span></label>
<input type="text" id="name" name="name" required>
</div>
<div class="form-group">
<label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
<input type="email" id="email" name="email" required>
</div>
<div class="form-group">
<label for="subject">ä»¶å <span class="required">*</span></label>
<select id="subject" name="subject" required>
<option value="">é¸æŠã—ã¦ãã ã•ã„</option>
<option value="general">ä¸€èˆ¬çš„ãªãŠå•ã„åˆã‚ã›</option>
<option value="support">ã‚µãƒãƒ¼ãƒˆ</option>
<option value="business">ãƒ“ã‚¸ãƒã‚¹é–¢é€£</option>
<option value="other">ãã®ä»–</option>
</select>
</div>
<div class="form-group">
<label for="message">ãŠå•ã„åˆã‚ã›å†…å®¹ <span class="required">*</span></label>
<textarea id="message" name="message" rows="6" required></textarea>
</div>
<button type="submit">é€ä¿¡ã™ã‚‹</button>
</form>
<div class="success" id="successMessage">
<h3>âœ… é€ä¿¡å®Œäº†</h3>
<p>ãŠå•ã„åˆã‚ã›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚<br>2å–¶æ¥­æ—¥ä»¥å†…ã«ã”è¿”ä¿¡ã„ãŸã—ã¾ã™ã€‚</p>
</div>
</div>
</div>
<script>
document.getElementById('contactForm').addEventListener('submit', function(e) {
e.preventDefault();
document.querySelector('.form').style.display = 'none';
document.getElementById('successMessage').style.display = 'block';
});
</script>
</body>
</html>`;
                console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯HTMLä½¿ç”¨');
              }

              // ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
              fs.writeFileSync('index.html', htmlCode);
              console.log('âœ… index.htmlä½œæˆå®Œäº†');

              // READMEä½œæˆ
              const readmeContent = `# ğŸŒ ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ 

ã“ã®ç¾ã—ã„ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã¯Claude API ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

## ğŸš€ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•
**ğŸ“± ãƒ•ã‚©ãƒ¼ãƒ URL:** https://${context.repo.owner}.github.io/${context.repo.repo}/

## âœ¨ æ©Ÿèƒ½
- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- ãƒ¢ãƒ€ãƒ³UI/UX
- é€ä¿¡ç¢ºèªæ©Ÿèƒ½

## ğŸ“ ç”Ÿæˆæƒ…å ±
- ç”Ÿæˆæ—¥æ™‚: ${new Date().toISOString()}
- Issue: #${issueNumber}
- ãƒ¢ãƒ‡ãƒ«: Claude Sonnet 4

---
*ğŸ¤– Claude Code Action ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆ*
`;

              fs.writeFileSync('README.md', readmeContent);
              console.log('âœ… README.mdä½œæˆå®Œäº†');

              core.setOutput('issue_number', issueNumber);
              return 'success';

            } catch (error) {
              console.log('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);

              // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯HTMLã‚’ä½œæˆ
              const fallbackHtml = `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </title>
<style>body{font-family:Arial,sans-serif;max-width:600px;margin:50px auto;padding:20px}input,textarea{width:100%;padding:10px;margin:10px 0;border:1px solid #ddd}</style>
</head>
<body>
<h1>ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ </h1>
<form><input type="text" placeholder="ãŠåå‰" required><input type="email" placeholder="ãƒ¡ãƒ¼ãƒ«" required><textarea placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" required></textarea><button type="submit">é€ä¿¡</button></form>
</body>
</html>`;

              fs.writeFileSync('index.html', fallbackHtml);
              fs.writeFileSync('README.md', '# ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ \n\nClaude APIã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');

              core.setOutput('issue_number', issueNumber);
              return 'fallback';
            }

      - name: Create branch and commit
        run: |
          BRANCH_NAME="contact-form-issue-${{ steps.generate-code.outputs.issue_number }}"
          echo "ğŸŒ¿ Creating branch: $BRANCH_NAME"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git checkout -b $BRANCH_NAME

          git add -A
          git commit -m "ğŸ¤– Auto-generated contact form for issue #${{ steps.generate-code.outputs.issue_number }}"
          git push origin $BRANCH_NAME

          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request and Auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.generate-code.outputs.issue_number }};
            const branchName = process.env.BRANCH_NAME;

            try {
              // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
              console.log('ğŸ”„ Creating pull request...');
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¤– ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ  for issue #${issueNumber}`,
                head: branchName,
                base: 'master',
                body: `## ğŸŒ ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ è‡ªå‹•ç”Ÿæˆ

ã“ã®PRã¯Issue #${issueNumber}ã«åŸºã¥ã„ã¦Claude APIã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

### ğŸ“ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
- **index.html**: ãƒ¡ã‚¤ãƒ³ã®ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ 
- **README.md**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•
**ğŸ“± ãƒ•ã‚©ãƒ¼ãƒ URL:** https://${context.repo.owner}.github.io/${context.repo.repo}/

Closes #${issueNumber}
`
              });

              console.log(`âœ… Pull Request #${pr.number} created`);

              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸
              await new Promise(resolve => setTimeout(resolve, 2000));

              // è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                commit_title: `ğŸš€ Deploy contact form #${issueNumber}`,
                merge_method: 'squash'
              });

              console.log(`âœ… Auto-merged PR #${pr.number}`);

              // GitHub Pagesè¨­å®š
              try {
                await github.rest.repos.createPagesSite({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  source: { branch: 'master', path: '/' }
                });
                console.log('âœ… GitHub Pages enabled');
              } catch (error) {
                console.log('ğŸ“ GitHub Pages already configured');
              }

              // å®Œäº†é€šçŸ¥
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ‰ ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ  ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼

**âœ… è‡ªå‹•å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ:**

### ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•
**ğŸ“± ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ :** https://${context.repo.owner}.github.io/${context.repo.repo}/

### ğŸ“‹ å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
- ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
- âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- ğŸ¨ ãƒ¢ãƒ€ãƒ³UI/UX
- ğŸ“§ é€ä¿¡ç¢ºèªæ©Ÿèƒ½

### âš¡ å‡¦ç†è©³ç´°
1. Claude Sonnet 4ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
2. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${pr.number} ä½œæˆãƒ»ãƒãƒ¼ã‚¸
3. GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤

æ•°åˆ†å¾Œã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ï¼

---
*ğŸ¤– LINE Bot â†’ Claude API â†’ GitHub Actions ã«ã‚ˆã‚‹å®Œå…¨è‡ªå‹•å‡¦ç†*`
              });

              // Issue ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
              await github.rest.issues.update({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });

              console.log(`âœ… Issue #${issueNumber} closed`);

            } catch (error) {
              console.log('âŒ Error in PR/merge process:', error.message);

              // ã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## âš ï¸ å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

ãƒ•ã‚©ãƒ¼ãƒ ã¯ç”Ÿæˆã•ã‚Œã¾ã—ãŸãŒã€ãƒãƒ¼ã‚¸å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
æ‰‹å‹•ã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

**ã‚¨ãƒ©ãƒ¼:** ${error.message}

---
*Claude Code Action*`
              });
            }

  deploy-to-pages:
    runs-on: ubuntu-latest
    name: Deploy to GitHub Pages
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v3

      - name: Upload artifacts
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
