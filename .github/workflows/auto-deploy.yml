name: Auto Code Generation and Deploy

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  auto-generate-and-deploy:
    runs-on: ubuntu-latest
    name: Auto Generate Code and Deploy
    if: |
      contains(github.event.issue.title, '@claude') && (
        contains(github.event.issue.labels.*.name, 'auto-deploy') ||
        contains(github.event.issue.labels.*.name, 'line-bot') ||
        contains(github.event.issue.body, 'ã‚³ãƒ¼ãƒ‰') ||
        contains(github.event.issue.body, 'ãƒ•ã‚©ãƒ¼ãƒ ') ||
        contains(github.event.issue.body, 'ä½œæˆ')
      )

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Generate code with Claude
        id: generate-code
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const Anthropic = require('@anthropic-ai/sdk');

            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;

            // Claude APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            try {
              console.log('ğŸ¤– Calling Claude API for code generation...');

              // Claudeã«ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ä¾é ¼
              const message = await anthropic.messages.create({
                model: 'claude-sonnet-4-20250514', // æœ€æ–°ã®Claude Sonnet 4ã«æ›´æ–°
                max_tokens: 4000,
                temperature: 0.3,
                messages: [{
                  role: 'user',
                  content: `ã‚ãªãŸã¯å„ªç§€ãªé–‹ç™ºè€…ã§ã™ã€‚ä»¥ä¸‹ã®ä¾é ¼ã«åŸºã¥ã„ã¦å®Ÿè£…å¯èƒ½ãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                  ä¾é ¼ã‚¿ã‚¤ãƒˆãƒ«: ${issueTitle}
                  è©³ç´°: ${issueBody}

                  ä»¥ä¸‹ã®å½¢å¼ã§è¿”ç­”ã—ã¦ãã ã•ã„ï¼š

                  ## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
                  [ä½œæˆãƒ»ä¿®æ­£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆ]

                  ## [ãƒ•ã‚¡ã‚¤ãƒ«å1]
                  \`\`\`[è¨€èª]
                  [ã‚³ãƒ¼ãƒ‰å†…å®¹]
                  \`\`\`

                  ## [ãƒ•ã‚¡ã‚¤ãƒ«å2]
                  \`\`\`[è¨€èª]
                  [ã‚³ãƒ¼ãƒ‰å†…å®¹]
                  \`\`\`

                  å®Ÿç”¨çš„ã§å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`
                }]
              });

              const generatedContent = message.content[0].text;
              console.log('âœ… Code generated successfully');

              // ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’JSONå½¢å¼ã§å‡ºåŠ›
              core.setOutput('generated_code', generatedContent);
              core.setOutput('issue_number', issueNumber);

              return generatedContent;

            } catch (error) {
              console.log('âš ï¸ Error calling Claude API:', error.message);
              throw error;
            }

      - name: Create new branch
        run: |
          BRANCH_NAME="auto-deploy-issue-${{ steps.generate-code.outputs.issue_number }}"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Parse and create files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const generatedCode = `${{ steps.generate-code.outputs.generated_code }}`;

            // Claudeã®å¿œç­”ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            const fileRegex = /## ([^\n]+)\n```(\w+)\n([\s\S]*?)```/g;
            let match;

            while ((match = fileRegex.exec(generatedCode)) !== null) {
              const fileName = match[1].trim();
              const language = match[2];
              const code = match[3];

              console.log(`Creating file: ${fileName}`);

              // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
              const dir = fileName.includes('/') ? fileName.substring(0, fileName.lastIndexOf('/')) : '';
              if (dir) {
                fs.mkdirSync(dir, { recursive: true });
              }

              // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
              fs.writeFileSync(fileName, code);
            }

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "ğŸ¤– Auto-generated code for issue #${{ steps.generate-code.outputs.issue_number }}"
          git push origin ${{ env.BRANCH_NAME }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.generate-code.outputs.issue_number }};
            const branchName = process.env.BRANCH_NAME;

            const { data: pullRequest } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– Auto-generated code for issue #${issueNumber}`,
              head: branchName,
              base: 'master',
              body: `
              ## ğŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰

              ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ Issue #${issueNumber} ã«åŸºã¥ã„ã¦ Claude API ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

              ### ğŸ“‹ å¤‰æ›´å†…å®¹
              - Claude API ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆ
              - å®Ÿè£…å¯èƒ½ãªå½¢å¼ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

              ### ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
              - [ ] ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒè¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹
              - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒãªã„ã‹
              - [ ] ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã‹

              Closes #${issueNumber}
              `
            });

            console.log(`âœ… Pull Request created: ${pullRequest.html_url}`);

      - name: Auto-merge if tests pass (optional)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = ${{ steps.generate-code.outputs.issue_number }};

            // LINEã‹ã‚‰ã®ä¾é ¼ã‹ã¤ã€å°ã•ãªå¤‰æ›´ã®å ´åˆã¯è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æ¤œè¨
            const issueBody = context.payload.issue.body;
            const isLineBot = issueBody.includes('LINE Bot');
            const isSimpleRequest = issueBody.includes('ãƒ•ã‚©ãƒ¼ãƒ ') || issueBody.includes('ãƒœã‚¿ãƒ³') || issueBody.includes('ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ');

            if (isLineBot && isSimpleRequest) {
              console.log('ğŸ¤– LINEã‹ã‚‰ã®ç°¡å˜ãªä¾é ¼ãªã®ã§ã€è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œã—ã¾ã™');

              // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒ¼ã‚¸å®Ÿè¡Œ
              await new Promise(resolve => setTimeout(resolve, 5000));

              try {
                // æœ€æ–°ã®PRã‚’å–å¾—
                const { data: pulls } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: `${context.repo.owner}:auto-deploy-issue-${issueNumber}`,
                  per_page: 1
                });

                if (pulls.length > 0) {
                  const pullNumber = pulls[0].number;

                  // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸
                  await github.rest.pulls.merge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pullNumber,
                    commit_title: `ğŸ¤– Auto-merge: ${pulls[0].title}`,
                    merge_method: 'squash'
                  });

                  console.log(`âœ… ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${pullNumber} ã‚’è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸ`);

                  // Issue ã«å®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆ
                  await github.rest.issues.createComment({
                    issue_number: issueNumber,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼

                    **LINEã‹ã‚‰ã®ä¾é ¼ãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã¾ã—ãŸï¼š**
                    1. âœ… Claude Sonnet 4 ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                    2. âœ… ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ #${pullNumber} ä½œæˆ
                    3. âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œ
                    4. âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

                    ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯æœ¬ç•ªç’°å¢ƒã«åæ˜ ã•ã‚Œã¾ã—ãŸï¼

                    ---
                    *è‡ªå‹•å‡¦ç†å®Œäº† - Claude Code Action*`
                  });

                  // Issue ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
                  await github.rest.issues.update({
                    issue_number: issueNumber,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'closed'
                  });

                } else {
                  console.log('âš ï¸ å¯¾è±¡ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }

              } catch (error) {
                console.log('âŒ è‡ªå‹•ãƒãƒ¼ã‚¸ã§ã‚¨ãƒ©ãƒ¼:', error.message);
              }
            } else {
              // é€šå¸¸ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ‰‹å‹•ãƒãƒ¼ã‚¸æ¨å¥¨ï¼‰
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ‰ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†ï¼

                ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€æ‰‹å‹•ã§ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚

                **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
                1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼
                2. ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
                3. ãƒãƒ¼ã‚¸ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

                ---
                *Claude API ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆ*`
              });
            }

  deploy-to-server:
    runs-on: ubuntu-latest
    name: Deploy to Server
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build || echo "No build script found"

      - name: Deploy to server (example)
        run: |
          echo "ğŸš€ Deploying to server..."
          # ã“ã“ã«å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ 
          # rsync -avz ./ user@server:/path/to/deploy/
          # or use FTP, SSH, etc.
          echo "âœ… Deploy completed"
